#include "QSearchMakeTree.hpp"
#include <cstring>

static QSearchMakeTree *qsmaketree;
static const std::string qsearch_package_version = "0.7.1"; 

void MakeTreeObserver::operator()(QSearchTree& old, QSearchTree& improved)
{
    std::cout << improved.score_tree() << "   (lmsd=" << mtr.tm.get_lmsd() << ")\n";
    make_tree.write_tree_file(improved);
}

void MakeTreeObserver::operator()(QSearchTree& final)
{
    std::cout << final.score_tree() << "\n";
    make_tree.write_tree_file(final);
}

void QSearchMakeTree::process_options(char **argv) 
{
#ifdef __EMSCRIPTEN__
  process_options_web(argv);
#else
  process_options_unix(argv);
#endif
}

const std::string smallTestMatrix = R"(orangutan 0.000000 0.922585 0.945596 0.943584 0.925649 0.943191 0.832902 0.923708
indianRhinoceros 0.928386 0.000000 0.932244 0.934446 0.884540 0.935471 0.926110 0.753351
opossum 0.947987 0.936429 0.000000 0.947358 0.937254 0.942399 0.938458 0.932045
elephant 0.939213 0.930870 0.941398 0.000000 0.922699 0.943785 0.940803 0.927493
cat 0.929976 0.894178 0.932927 0.931157 0.000000 0.934894 0.927616 0.887884
platypus 0.950911 0.935273 0.938836 0.955265 0.929976 0.000000 0.944181 0.941409
pigmyChimpanzee 0.823939 0.924119 0.934276 0.941796 0.926633 0.944181 0.000000 0.917347
whiteRhinoceros 0.929716 0.751550 0.937027 0.931069 0.889851 0.942795 0.922127 0.000000
)";

const std::string testMatrix = R"(orangutan 0.000000 0.922585 0.945596 0.943584 0.925649 0.943191 0.832902 0.923708 0.934718 0.933068 0.925896 0.832006 0.918630 0.920489 0.932070 0.923806 0.927539 0.929783 0.936461 0.934518 0.930746 0.925213 0.943511 0.918696 0.900737 0.930200 0.929873 0.926854 0.828905 0.925607 0.818363 0.921321 0.862585 0.921005 
indianRhinoceros 0.928386 0.000000 0.932244 0.934446 0.884540 0.935471 0.926110 0.753351 0.903264 0.910757 0.893579 0.924960 0.880976 0.887578 0.913983 0.911782 0.916650 0.857371 0.924782 0.907766 0.905672 0.882166 0.934519 0.892579 0.927447 0.911800 0.918780 0.898580 0.925785 0.848770 0.920335 0.889578 0.921819 0.881907 
opossum 0.947987 0.936429 0.000000 0.947358 0.937254 0.942399 0.938458 0.932045 0.935509 0.936255 0.938023 0.938694 0.930052 0.934635 0.924671 0.938023 0.940012 0.944599 0.937648 0.937027 0.930746 0.929776 0.896990 0.933041 0.944002 0.932244 0.937599 0.937425 0.944201 0.936827 0.941446 0.938422 0.942009 0.931646 
elephant 0.939213 0.930870 0.941398 0.000000 0.922699 0.943785 0.940803 0.927493 0.933729 0.934843 0.932459 0.940207 0.922328 0.928486 0.932062 0.934247 0.933281 0.930671 0.936857 0.937028 0.920938 0.924420 0.942142 0.931069 0.941398 0.933055 0.932647 0.927096 0.939809 0.930671 0.932857 0.933651 0.937823 0.924911 
cat 0.929976 0.894178 0.932927 0.931157 0.000000 0.934894 0.927616 0.887884 0.885327 0.910897 0.912077 0.922109 0.900472 0.892211 0.917191 0.915224 0.913061 0.894178 0.918961 0.911487 0.909323 0.869591 0.928264 0.904013 0.931747 0.908930 0.920928 0.901259 0.928009 0.887884 0.927223 0.901456 0.924272 0.866050 
platypus 0.950911 0.935273 0.938836 0.955265 0.929976 0.000000 0.944181 0.941409 0.940455 0.941013 0.935273 0.945566 0.928345 0.936659 0.934086 0.935867 0.943785 0.942201 0.940816 0.936659 0.936263 0.932898 0.933151 0.932898 0.948931 0.936857 0.944774 0.936659 0.941013 0.940024 0.944378 0.933888 0.948535 0.933492 
pigmyChimpanzee 0.823939 0.924119 0.934276 0.941796 0.926633 0.944181 0.000000 0.917347 0.929377 0.924517 0.920534 0.413814 0.914758 0.918144 0.927903 0.921928 0.925361 0.926509 0.932502 0.926110 0.927562 0.910930 0.935692 0.916550 0.898427 0.923920 0.925317 0.924318 0.711810 0.919538 0.652659 0.920135 0.840470 0.913563 
whiteRhinoceros 0.929716 0.751550 0.937027 0.931069 0.889851 0.942795 0.922127 0.000000 0.895747 0.921912 0.890268 0.917795 0.884061 0.883660 0.910693 0.908891 0.916848 0.847796 0.925772 0.914554 0.908060 0.887522 0.932955 0.891470 0.931832 0.922000 0.920563 0.895675 0.921706 0.842411 0.916351 0.900501 0.920024 0.886894 
dog 0.934520 0.900297 0.928783 0.931751 0.877459 0.931553 0.926805 0.893373 0.000000 0.911375 0.900495 0.922849 0.892186 0.896538 0.906627 0.907418 0.911968 0.897725 0.919090 0.908408 0.903462 0.868051 0.930219 0.900692 0.931553 0.912957 0.916518 0.904649 0.929773 0.893571 0.922849 0.900692 0.928783 0.866073 
fatDormouse 0.931275 0.915737 0.930080 0.941398 0.906373 0.934086 0.928301 0.917331 0.914540 0.000000 0.925100 0.929936 0.901793 0.918127 0.909562 0.909562 0.916848 0.918127 0.922407 0.916932 0.918408 0.909343 0.930610 0.913944 0.934462 0.912948 0.931260 0.921713 0.930279 0.913745 0.932284 0.912550 0.930677 0.912550 
finWhale 0.932706 0.898980 0.933838 0.933254 0.908143 0.937055 0.926110 0.892070 0.907221 0.925299 0.000000 0.927946 0.883637 0.885239 0.923693 0.919688 0.920412 0.894075 0.924386 0.906169 0.910249 0.900813 0.932760 0.607250 0.925055 0.918000 0.919572 0.885640 0.928700 0.897857 0.923521 0.889890 0.924811 0.898265 
chimpanzee 0.819467 0.924363 0.935709 0.941994 0.923682 0.945368 0.414013 0.914013 0.923442 0.928742 0.922174 0.000000 0.913416 0.916003 0.927946 0.925756 0.926747 0.926951 0.933096 0.925358 0.927761 0.915096 0.938233 0.917596 0.897691 0.923965 0.924723 0.924363 0.708400 0.921775 0.651672 0.924562 0.836584 0.920183 
cow 0.924673 0.883977 0.933240 0.930473 0.903029 0.931908 0.922525 0.886264 0.902671 0.910757 0.876828 0.924164 0.000000 0.880433 0.920443 0.911984 0.904771 0.889886 0.920823 0.906568 0.905274 0.881968 0.929437 0.874824 0.929041 0.914800 0.910261 0.884970 0.919887 0.891919 0.917945 0.801401 0.925209 0.879513 
pig 0.926697 0.886977 0.931048 0.929082 0.887687 0.937451 0.922326 0.880056 0.898912 0.919124 0.881634 0.923169 0.874624 0.000000 0.911676 0.904266 0.910117 0.890285 0.918052 0.903973 0.902687 0.883555 0.931587 0.874224 0.926849 0.913000 0.905705 0.896455 0.917284 0.891648 0.917745 0.883684 0.922816 0.882904 
mouse 0.939125 0.922985 0.931845 0.943981 0.913454 0.935075 0.936268 0.920304 0.919288 0.915936 0.929501 0.934514 0.915206 0.921290 0.000000 0.846451 0.922986 0.923000 0.929731 0.926532 0.918408 0.918469 0.931587 0.916482 0.941997 0.920400 0.926902 0.927856 0.933172 0.927411 0.931886 0.923524 0.937575 0.919609 
rat 0.933481 0.921784 0.935632 0.941398 0.916994 0.937846 0.929894 0.915098 0.922255 0.913347 0.918286 0.925955 0.911782 0.910074 0.848688 0.000000 0.922194 0.915819 0.930721 0.929527 0.917413 0.912319 0.929242 0.917690 0.935818 0.919600 0.919176 0.920040 0.930757 0.914177 0.926907 0.914515 0.936378 0.913625 
rabbit 0.931499 0.909523 0.931103 0.935260 0.905389 0.939826 0.925955 0.912097 0.915727 0.911503 0.918630 0.923579 0.903385 0.904177 0.906553 0.913482 0.000000 0.905959 0.917458 0.911107 0.903781 0.906553 0.928460 0.905563 0.927341 0.908335 0.919620 0.916848 0.919026 0.910513 0.920610 0.910909 0.927341 0.907741 
donkey 0.929384 0.848394 0.934835 0.928288 0.884540 0.936263 0.917745 0.837223 0.897329 0.912151 0.887094 0.923368 0.882306 0.884500 0.912228 0.910233 0.904177 0.000000 0.923990 0.901855 0.907463 0.879786 0.931196 0.884101 0.931433 0.910233 0.913827 0.893676 0.923200 0.589068 0.914957 0.889088 0.916035 0.882705 
guineaPig 0.934283 0.922407 0.937846 0.939628 0.915618 0.939430 0.936065 0.925376 0.920870 0.918052 0.922407 0.933690 0.915479 0.918250 0.922209 0.919240 0.921219 0.925376 0.000000 0.924782 0.918448 0.914291 0.927873 0.918448 0.935471 0.920032 0.931314 0.922407 0.925376 0.923199 0.931908 0.919636 0.932106 0.918448 
fruitBat 0.931324 0.905770 0.931447 0.937028 0.901652 0.933888 0.929496 0.909962 0.908803 0.916932 0.905370 0.924761 0.898383 0.898383 0.917548 0.916351 0.913284 0.900259 0.921219 0.000000 0.913035 0.904186 0.932565 0.900779 0.937612 0.917149 0.927496 0.918946 0.918147 0.900978 0.925911 0.899381 0.927802 0.907640 
aardvark 0.931940 0.909652 0.927164 0.926103 0.906176 0.939628 0.930149 0.908259 0.909001 0.918607 0.911045 0.929950 0.901095 0.905274 0.914428 0.913831 0.909721 0.912836 0.921813 0.916020 0.000000 0.903591 0.929437 0.906866 0.931940 0.920000 0.917195 0.910846 0.928358 0.911045 0.926567 0.911841 0.929353 0.904478 
harborSeal 0.932355 0.888316 0.933545 0.926602 0.872541 0.933294 0.924023 0.891291 0.872601 0.910732 0.909145 0.919460 0.886134 0.892878 0.916485 0.914699 0.909325 0.891490 0.916865 0.910930 0.906765 0.000000 0.924746 0.894862 0.931164 0.910137 0.910261 0.891291 0.927197 0.883356 0.924023 0.893672 0.926403 0.385043 
wallaroo 0.944488 0.931783 0.889562 0.941165 0.924355 0.930219 0.935887 0.922205 0.931978 0.931196 0.927678 0.934910 0.922205 0.924746 0.921423 0.923378 0.929242 0.931001 0.931392 0.934324 0.929242 0.919859 0.000000 0.926114 0.944879 0.927482 0.926505 0.927678 0.938038 0.931783 0.934324 0.926114 0.935106 0.918882 
blueWhale 0.929161 0.896979 0.935233 0.933651 0.907160 0.936263 0.924318 0.893472 0.905638 0.921315 0.615462 0.923567 0.884685 0.882235 0.920105 0.921312 0.916650 0.894873 0.922803 0.907167 0.911841 0.892085 0.932760 0.000000 0.927247 0.915800 0.918185 0.881363 0.928758 0.902346 0.923920 0.887287 0.924811 0.893477 
baboon 0.899342 0.928643 0.942407 0.947755 0.930763 0.950713 0.902609 0.927646 0.939070 0.939243 0.922065 0.901075 0.927048 0.926051 0.933028 0.932230 0.927341 0.936616 0.939232 0.942794 0.932139 0.927792 0.942533 0.918278 0.000000 0.935619 0.935222 0.930038 0.895754 0.931832 0.893049 0.935220 0.895754 0.927048 
squirrel 0.927600 0.911600 0.924870 0.934247 0.901259 0.932898 0.927504 0.912000 0.911375 0.906972 0.912400 0.923368 0.901800 0.907200 0.910800 0.907800 0.906949 0.918412 0.919636 0.916351 0.916418 0.903789 0.926701 0.909200 0.933426 0.000000 0.917195 0.912200 0.920200 0.912000 0.919538 0.915400 0.922018 0.900060 
armadillo 0.932647 0.921949 0.941165 0.936212 0.915028 0.944181 0.929873 0.920761 0.929575 0.924921 0.919374 0.925911 0.906696 0.901347 0.916997 0.915016 0.922986 0.921949 0.937648 0.930071 0.921553 0.909865 0.930805 0.911252 0.934231 0.921157 0.000000 0.921553 0.930864 0.919176 0.923930 0.921751 0.930864 0.912044 
hippopotamus 0.927856 0.895979 0.938023 0.928685 0.895948 0.936065 0.923521 0.889067 0.909001 0.923705 0.881634 0.923169 0.877756 0.888043 0.916433 0.914028 0.920610 0.897666 0.932898 0.919146 0.908856 0.887721 0.931196 0.875150 0.929241 0.921200 0.916997 0.000000 0.920641 0.889780 0.919339 0.886486 0.927603 0.888490 
gorilla 0.824074 0.925585 0.944998 0.947557 0.930960 0.943983 0.728540 0.921306 0.938675 0.935458 0.926898 0.725119 0.918277 0.922091 0.930153 0.927335 0.923382 0.930979 0.934283 0.930525 0.927960 0.926205 0.940188 0.924733 0.903528 0.929400 0.932052 0.925852 0.000000 0.928614 0.717387 0.928529 0.849023 0.921803 
horse 0.928013 0.847770 0.934436 0.934843 0.877262 0.941409 0.918940 0.837805 0.893373 0.912351 0.890847 0.921377 0.883096 0.892249 0.917786 0.906156 0.912889 0.594853 0.924782 0.909164 0.914428 0.876413 0.930610 0.889914 0.931034 0.912600 0.917987 0.892184 0.924403 0.000000 0.919538 0.890891 0.921819 0.880311 
human 0.823541 0.922127 0.943039 0.942590 0.931747 0.947546 0.664210 0.919936 0.935905 0.931886 0.928102 0.660430 0.925513 0.921928 0.937463 0.934874 0.930311 0.931488 0.933096 0.930691 0.928955 0.925610 0.941165 0.924517 0.906194 0.923521 0.928288 0.928899 0.725951 0.924318 0.000000 0.924119 0.840470 0.930691 
sheep 0.922322 0.887177 0.934436 0.928685 0.899489 0.934481 0.919140 0.895295 0.896736 0.908566 0.881682 0.917994 0.786987 0.879680 0.907908 0.903103 0.906751 0.893676 0.922011 0.896387 0.906468 0.884943 0.927287 0.876476 0.931234 0.913400 0.916601 0.886687 0.916717 0.889489 0.915953 0.000000 0.919027 0.885298 
gibbon 0.852812 0.923614 0.943204 0.941398 0.926042 0.949129 0.841267 0.918229 0.930959 0.929283 0.927004 0.839172 0.917631 0.924013 0.925010 0.930395 0.928331 0.922218 0.935471 0.928799 0.928358 0.924817 0.936083 0.921819 0.896153 0.924811 0.927496 0.928600 0.834464 0.921221 0.839873 0.925808 0.000000 0.921221 
graySeal 0.935368 0.890485 0.935632 0.934247 0.879032 0.939430 0.929297 0.893477 0.883482 0.919522 0.910034 0.925756 0.890884 0.897267 0.924796 0.919609 0.914076 0.897068 0.922209 0.915619 0.910448 0.383852 0.930610 0.903451 0.934224 0.917614 0.921355 0.899461 0.926591 0.889288 0.928102 0.893078 0.929797 0.000000 
)";

void QSearchMakeTree::make_tree(const std::string& matstr)
{
    QMatrix<double> dm;     // owner of matrix?

    dm.from_string(matstr);
    dm.make_symmetric();
    std::cout << "Starting search on matrix size " << dm.dim << "\n";
    QSearchManager cltm(dm);
    QSearchTree tree(dm);
    MakeTreeResult mtr(cltm,tree);
    MakeTreeObserver mto( *this, mtr );
    cltm.add_observer(mto, mto, mto);
    cltm.find_best_tree();
}

void QSearchMakeTree::make_tree(const std::string& matstr, start_fn tree_search_started, improve_fn tried_to_improve, done_fn tree_search_done)
{
    QMatrix<double> dm;     // owner of matrix?

    dm.from_string(testMatrix);
    dm.make_symmetric();
    std::cout << "Starting search on matrix size " << dm.dim << "\n";
    QSearchManager cltm(dm);
    QSearchTree tree(dm);
    MakeTreeResult mtr(cltm,tree);
    MakeTreeObserver mto( *this, mtr );
    cltm.add_observer(mto, mto, mto);
    cltm.add_observer(tree_search_started, tried_to_improve, tree_search_done);
    cltm.find_best_tree();
}

void QSearchMakeTree::process_options_web(char **argv) 
{
    std::string matstr;
    char **cur;
    for (cur = argv+1; *cur; cur += 1) {
      if (strcmp(*cur, "-o") == 0) {
      if (cur[1] == NULL)
        std::cout << "-o requires an argument";
        filestem = cur[1];
        cur += 1;
        continue;
      }
      if (strcmp(*cur, "-v") == 0 || strcmp(*cur, "--version") == 0) {
        std::cout << qsearch_package_version << "\n";
        exit(0);
      }
      if (strcmp(*cur, "-n") == 0) {
        output_nexus = true;
        continue;
      }
      std::cout << "Unrecognized argument: " << *cur;
    }
    matstr = smallTestMatrix;
    filestem = "-";
    make_tree(matstr);
}

void QSearchMakeTree::process_options_unix(char **argv) 
{
  std::string matstr;
  char **cur;
  for (cur = argv+1; *cur; cur += 1) {
    if (strcmp(*cur, "-o") == 0) {
    if (cur[1] == NULL)
      std::cout << "-o requires an argument";
      filestem = cur[1];
      cur += 1;
      continue;
    }
    if (strcmp(*cur, "-v") == 0 || strcmp(*cur, "--version") == 0) {
      std::cout << qsearch_package_version << "\n";
      exit(0);
    }
    if (strcmp(*cur, "-n") == 0) {
      output_nexus = true;
      continue;
    }
    if (matrix_filename.length() == 0) {
      matrix_filename = *cur;
      continue;
    }
    std::cout << "Unrecognized argument: " << *cur;
  }
  if (matrix_filename.empty()) print_help_and_exit();
  read_whole_file(matstr, matrix_filename);
  make_tree(matstr);
}

// Full implementation deferred
void QSearchMakeTree::write_tree_file(QSearchTree& tree) {
  if (output_nexus) {
    /* deferred
    char *fname = g_strdup_printf("%s.nex", top().get_filestem());
    char *nex_str = qsearch_tree_to_nexus_full(mtr.tree, mtr.mat);
    GString *gf = g_string_new(nex_str);
    complearn_write_file(fname, gf); 
    */
  }
  else {
    if (filestem.compare("-") == 0) {
      std::cout << tree.to_dot();
    }
    else {
    std::string fname = filestem + ".dot";
    write_whole_file( tree.to_dot(), fname );
    }
  }
}

void QSearchMakeTree::print_help_and_exit() // Say "friend" and enter
{
  std::cout << "Usage:\n\n";
  std::cout << "maketree [-v] [-n] <distmatrix>\n";
  std::cout << "          -v  print version\n";
  std::cout << "          -n  nexus instead of dot output format\n";
  exit(0);
}
